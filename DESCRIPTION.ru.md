# Бизнес-логика приложения Borsibaar

## Общее описание
Система управления складом/инвентарем для баров/ресторанов с мультитенантной архитектурой. Каждая организация управляет своими продуктами, инвентарем, категориями, пользователями и барными станциями.

---

## Основные доменные сущности

### 1. Organization (Организация)
- Корневая сущность мультитенантности
- Параметры динамического ценообразования: `priceIncreaseStep`, `priceDecreaseStep`
- Настройки применяются ко всем продуктам организации

### 2. User (Пользователь)
- Аутентификация через OAuth2 (Google)
- Роли: `USER`, `ADMIN`
- Привязка к одной организации (`organizationId`)
- Связь many-to-many с `BarStation` (доступ к станциям)

### 3. Category (Категория)
- Группировка продуктов
- Флаг `dynamicPricing` (включение динамического ценообразования)

### 4. Product (Продукт)
- Каталог товаров
- Цены: `basePrice`, `minPrice`, `maxPrice`
- Флаг `isActive` (soft delete)
- Привязка к категории и организации

### 5. Inventory (Инвентарь)
- Текущие остатки по продукту
- `quantity` (неотрицательное значение)
- `adjustedPrice` (текущая цена с учетом динамики)

### 6. InventoryTransaction (Транзакция инвентаря)
- Аудит изменений остатков и цен
- Типы: `SALE`, `PURCHASE`, `ADJUSTMENT`, `RETURN`, `TRANSFER_IN`, `TRANSFER_OUT`, `INITIAL`
- Сохраняет: `quantityBefore`, `quantityAfter`, `priceBefore`, `priceAfter`, `createdBy`, `barStationId`, `referenceId`

### 7. BarStation (Барная станция)
- Точки продаж (POS)
- Связь many-to-many с пользователями
- Используется для отслеживания продаж по станциям

---

## Основные бизнес-процессы

### 1. Аутентификация и авторизация
- OAuth2 через Google
- JWT токены в HTTP-only cookies
- Проверка организации на каждом запросе
- Onboarding: первый пользователь организации становится `ADMIN`

### 2. Управление продуктами
- **Создание**: автоматически создается запись инвентаря с `quantity = 0` и транзакция `INITIAL`
- **Удаление**: soft delete (`isActive = false`)
- **Валидация**: уникальность имени в рамках организации (case-insensitive)

### 3. Управление инвентарем

**Добавление остатков (`PURCHASE`)**:
- Увеличивает `quantity`
- Создает транзакцию типа `PURCHASE`
- Цена не меняется

**Удаление остатков (`ADJUSTMENT`)**:
- Уменьшает `quantity` (проверка на отрицательное значение)
- Создает транзакцию типа `ADJUSTMENT` с отрицательным `quantityChange`
- Можно указать `referenceId` и `notes`

**Корректировка остатков (`ADJUSTMENT`)**:
- Устанавливает новое значение `quantity`
- Создает транзакцию с разницей

### 4. Динамическое ценообразование

**При продаже (`SalesService.processSaleItem`)**:
- Если категория с `dynamicPricing = true`:
  - Цена увеличивается на `organization.priceIncreaseStep`
  - Ограничение: не выше `product.maxPrice`
  - Новая цена сохраняется в `inventory.adjustedPrice`
- Если `dynamicPricing = false`: цена не меняется

**Автоматическое снижение цен (`PriceCorrectionJob`)**:
- Запускается каждую минуту (`@Scheduled(cron = "0 * * * * *")`)
- Находит продукты без продаж за последнюю минуту
- Снижает цену на `organization.priceDecreaseStep`
- Ограничение: не ниже `product.minPrice`
- Создает транзакцию типа `ADJUSTMENT` с изменением цены (количество не меняется)

### 5. Продажи (POS)

**Процесс продажи (`SalesService.processSale`)**:
1. Генерация уникального `saleId` (формат: `SALE-{timestamp}`)
2. Для каждого товара:
   - Проверка наличия остатков
   - Проверка активности продукта
   - Проверка принадлежности к организации
   - Расчет цены (с учетом динамического ценообразования)
   - Уменьшение остатков
   - Обновление цены (если включено динамическое ценообразование)
   - Создание транзакции типа `SALE` с отрицательным `quantityChange`
   - Привязка к `barStationId` и `userId`
3. Возврат: список проданных товаров, общая сумма, `saleId`

**Валидации**:
- Недостаточно остатков → ошибка
- Продукт неактивен → ошибка
- Продукт не принадлежит организации → ошибка 403

### 6. Управление барными станциями

**Создание/обновление**:
- Только для `ADMIN`
- Назначение пользователей (many-to-many)
- Валидация уникальности имени в рамках организации

**Доступ**:
- `ADMIN`: видит все станции организации
- `USER`: видит только назначенные станции
- Если у `USER` одна станция → автоматический редирект на POS

### 7. Аналитика и отчетность

**Статистика по пользователям (`getUserSalesStats`)**:
- Группировка по `userId` + `barStationId`
- Подсчет уникальных продаж (`referenceId`)
- Расчет выручки (по `basePrice`)

**Статистика по станциям (`getStationSalesStats`)**:
- Группировка по `barStationId`
- Подсчет уникальных продаж
- Расчет общей выручки

**Отображение на Dashboard**:
- Таблица лидеров по станциям
- Таблица производительности пользователей
- Настройки организации (только для `ADMIN`)

### 8. История транзакций

**Просмотр истории (`getTransactionHistory`)**:
- Все транзакции по продукту
- Сортировка по дате (новые сверху)
- Отображение: тип, изменение количества, цены до/после, пользователь, дата, `referenceId`, `notes`

---

## Бизнес-правила и ограничения

### 1. Мультитенантность
- Все операции изолированы по `organizationId`
- Проверка принадлежности перед каждой операцией

### 2. Остатки
- Не могут быть отрицательными (CHECK constraint + валидация в коде)
- При продаже проверяется достаточность остатков

### 3. Ценообразование
- Динамическое ценообразование работает только для категорий с `dynamicPricing = true`
- Цены ограничены `minPrice` и `maxPrice`
- Автоматическое снижение только для продуктов без продаж

### 4. Продукты
- Уникальность имени в рамках организации (case-insensitive)
- Soft delete (`isActive = false`)
- При создании автоматически создается инвентарь с нулевым остатком

### 5. Пользователи
- Один пользователь = одна организация
- Первый пользователь организации автоматически становится `ADMIN`
- Пользователи могут быть назначены на несколько барных станций

### 6. Транзакции
- Неизменяемые (immutable)
- Всегда сохраняют состояние до и после изменения
- Связь с пользователем (`createdBy`) и станцией (`barStationId`)

---

## Пользовательские сценарии

### 1. Администратор
- Управление организацией (настройка шагов ценообразования)
- Управление категориями и продуктами
- Управление барными станциями и пользователями
- Просмотр аналитики продаж

### 2. Пользователь (бармен)
- Доступ к назначенным барным станциям
- Продажа товаров через POS
- Просмотр остатков и цен

### 3. Менеджер инвентаря
- Управление остатками (добавление, удаление, корректировка)
- Просмотр истории транзакций
- Создание новых продуктов и категорий

---

## Технические особенности

- **Транзакционность**: все операции с инвентарем выполняются в `@Transactional`
- **Аудит**: все изменения фиксируются в `InventoryTransaction`
- **Производительность**: групповые запросы для статистики, eager loading для связанных сущностей
- **Безопасность**: проверка прав доступа на уровне сервисов и контроллеров

---

Это описание отражает текущую бизнес-логику приложения на основе анализа кодовой базы.
